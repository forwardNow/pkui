define(function(a){"use strict";function b(a){this.opts=c.extend(!0,{},this.defaults,a),this.$target=c(this.opts.targetSelector),this.init()}a("jquery-ui");var c=a("jquery"),d=a("./menuSource"),e=window.layer,f=a("./app"),g="pkui.search";return b.prototype.defaults={targetSelector:null,blurElementSelector:".da",template:'<div class="pkui-search-popup" id="pkui-search-popup"><i class="fa fa-search pkui-search-icon"></i><input type="text" id="pkui-search-input" class="pkui-search-input" placeholder="请输入应用名称"></div>'},b.prototype.init=function(){this._render(),this._getData(),this._fmtData(),this._bind()},b.prototype._render=function(){this.$blur=c(this.opts.blurElementSelector)},b.prototype._bind=function(){var a=this;this.$target.on("click."+g,function(b){return a.data?(a.show(),void b.stopPropagation()):(e.alert("初始时获取菜单数据失败，无法启用搜索功能，正在尝试重新获取菜单数据！",{icon:2}),a._getData(),void a._fmtData())}),c(document).on("click."+g,function(b){var d=b.target;a.$popup&&(c.contains(a.$popup.get(0),d)||a.hide())})},b.prototype._create=function(){var a=this;this.$popup=c(this.opts.template).appendTo(c(document.body)),c.ui.autocomplete.prototype._renderItem=function(a,b){return c("<li>").append(c("<div>").html('<i class="'+b.icon+'"></i>'+b.label)).appendTo(a)},c("#pkui-search-input").autocomplete({appendTo:"#pkui-search-popup",source:function(b,d){var e=new RegExp(c.ui.autocomplete.escapeRegex(b.term),"i");d(c.map(a.data,function(a){var d=a.value;if(!b.term||e.test(d))return{label:d.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+c.ui.autocomplete.escapeRegex(b.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"),value:d,menuId:a.menuId,icon:a.icon}}))}}).on("focus",function(){c(this).autocomplete("search")}).on("autocompleteselect",function(b,d){var e=d.item;c(this).autocomplete("close"),a.hide(),new f(null,{icon:e.icon,title:e.value,src:"__CTX__/static/desktop/tpl/system/index.html",menuId:e.menuId,mode:"default"})}),this.isCreated=!0},b.prototype.show=function(){this.isCreated||this._create(),0===this.$blur.size()&&(this.$blur=c(this.opts.blurElementSelector)),this.$blur.addClass("blur"),this.$popup.show()},b.prototype.hide=function(){this.$popup.hide(),this.$blur.removeClass("blur")},b.prototype._getData=function(){this.data=d.getList()},b.prototype._fmtData=function(){var a=[];c.each(this.data,function(b,c){"1"===c.visiable&&a.push({menuId:c.menuId,value:c.menuName,icon:c.icon})}),this.data=a},b});