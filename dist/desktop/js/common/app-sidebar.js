define(function(a){"use strict";function b(a){this.opts=c.extend(!0,{},this.defaults,a),this._init()}var c=a("jquery"),d=window.layer,e=a("./menuSource"),f=a("./app"),g="pkui.sidebar",h=a("artTemplate");return b.prototype.defaults={oftenUsedUrl:null,recentUsedUrl:null,saveUsedMenuUrl:null,toggleSelector:null,sidebarSelector:null,sidebarBodySelecotr:null,closeBtnSelector:".da-sidebar-closeBtn",saveDelayTime:18e4,maxOftenUsedItemNum:6,maxRecentUsedItemNum:10,template:null},b.prototype.defaults.template='<dl class="use-group use-group-often">    <dt class="use-group-header">常用功能</dt>    {{each oftenUsedMenuList }}        {{if $index < '+b.prototype.defaults.maxOftenUsedItemNum+'}}        <dd class="use-group-item" data-menu-id="{{$value.menuId}}" data-menu-name="{{$value.menuName}}" data-icon="{{$value.icon}}">            <a href="#"><i class="{{$value.icon}}"></i> {{$value.menuName}}</a><span class="count">{{$value.count}}</span></dd>        {{/if}}    {{/each}}</dl><dl class="use-group use-group-recent">    <dt class="use-group-header">最近使用</dt>    {{each recentUsedMenuList }}        {{if $index < '+b.prototype.defaults.maxRecentUsedItemNum+'}}        <dd class="use-group-item" data-menu-id="{{$value.menuId}}" data-menu-name="{{$value.menuName}}" data-icon="{{$value.icon}}">            <a href="#"><i class="{{$value.icon}}"></i> {{$value.menuName}}</a></dd>        {{/if}}    {{/each}}</dl>',b.prototype._init=function(){var a=this;this._render(),this._bind(),this.templateRender=h.compile(this.opts.template),this._getData(function(){a._fmtData(),a.draw()})},b.prototype._render=function(){this.$toggle=c(this.opts.toggleSelector),this.$sidebar=c(this.opts.sidebarSelector),this.$sidebarBody=c(this.opts.sidebarBodySelecotr)},b.prototype._bind=function(){var a,b=this;this.$toggle.on("click."+g,function(){b.isShown()?b.hide():b.show()}),this.$sidebar.on("click."+g,this.opts.closeBtnSelector,function(){b.hide()}),this.$sidebar.on("click."+g,".use-group-item",function(){var a=c(this);new f(null,{icon:a.data("icon"),title:a.data("menuName"),src:"./tpl/system/index.html",menuId:a.data("menuId"),mode:"default"})}),c(document).on("inited.app",function(a,c){var d,e;c&&(d=c.menuId,null!==d&&void 0!==d&&(e=c.mode,"default"===e&&b.redraw(c.menuId)))}),this.$sidebar.on("changed."+g,function(){a&&window.clearTimeout(a),a=window.setTimeout(function(){b.save(),a=null},b.opts.saveDelayTime)}),c(window).unload(function(){a&&(b.save(!0),window.clearTimeout(a))})},b.prototype._getData=function(a){function b(){c.hasOwnProperty("sysMenuList")&&c.hasOwnProperty("oftenUsedMenuList")&&c.hasOwnProperty("recentUsedMenuList")&&a&&a()}var c=this;this.sysMenuList=e.getList(),this._request(this.opts.oftenUsedUrl,function(a){c.oftenUsedMenuList=a.data||[],b()}),this._request(this.opts.recentUsedUrl,function(a){c.recentUsedMenuList=a.data||[],b()})},b.prototype._request=function(a,b){c.ajax({url:a}).done(function(a){return a&&a.success!==!1?void(b&&b(a)):void d.alert(a&&a.message||"【应用侧边栏】请求数据失败：服务器内部错误！",{icon:2})}).fail(function(){d.alert("【应用侧边栏】请求数据失败：网络错误/登陆失效。",{icon:0})}).always(function(){})},b.prototype.isShown=function(){return this.$sidebar.is(".app-sidebar-showed")},b.prototype.show=function(){var a=this.$sidebar;a.stop().animate({left:0},function(){a.addClass("app-sidebar-showed")})},b.prototype.hide=function(){var a=this.$sidebar;a.stop().animate({left:-a.outerWidth()},function(){a.removeClass("app-sidebar-showed")})},b.prototype.draw=function(){var a;a=this.templateRender({oftenUsedMenuList:this.oftenUsedMenuList,recentUsedMenuList:this.recentUsedMenuList}),this.$sidebarBody.html(a)},b.prototype._fmtData=function(){var a,b,d,e,f,g=this;if(this.sysMenuList&&(a={},c.each(this.sysMenuList,function(b,c){a[c.menuId]={menuId:c.menuId,menuName:c.menuName,icon:c.icon}}),this.sysMenuList=a),this.oftenUsedMenuList&&"string"==typeof this.oftenUsedMenuList&&this.oftenUsedMenuList.indexOf(":")!==-1){try{a=[],this.oftenUsedMenuList=this.oftenUsedMenuList.replace(/'/g,'"'),this.oftenUsedMenuList=c.parseJSON(this.oftenUsedMenuList)}catch(a){b=g.oftenUsedMenuList.lastIndexOf(","),d=g.oftenUsedMenuList.substring(0,b)+"}",g.oftenUsedMenuList=c.parseJSON(d)}for(e in g.oftenUsedMenuList)g.oftenUsedMenuList.hasOwnProperty(e)&&(f=g.sysMenuList[e],f.count=g.oftenUsedMenuList[e],a.push(f));g.oftenUsedMenuList=a}!this.recentUsedMenuList||"string"!=typeof this.recentUsedMenuList||1!==this.recentUsedMenuList.length&&this.recentUsedMenuList.indexOf(",")===-1||(a=[],this.recentUsedMenuList=this.recentUsedMenuList.split(","),c.each(this.recentUsedMenuList,function(b,c){f=g.sysMenuList[c],f.hasOwnProperty("menuId")&&a.push(f)}),this.recentUsedMenuList=a),this._sortOftenUsedMenuList()},b.prototype.redraw=function(a){var b,c,d,e=this.recentUsedMenuList,f=this.oftenUsedMenuList;if(null===a||void 0===a||!this.sysMenuList[a]||!e||!f)return void console.error("无法重新绘制侧边栏。");for(c=e.length,b=c-1;b>=0;b--)e[b].menuId===a&&e.splice(b,1);if(e.unshift(this.sysMenuList[a]),this._isInOftenUsedList(a)){for(b=0,c=f.length;b<c;b++)if(f[b].menuId===a){f[b].count++;break}}else d=this.sysMenuList[a],d.count=1,f.push(d);this._sortOftenUsedMenuList(),this.draw(),this.$sidebar.trigger("changed."+g)},b.prototype._isInOftenUsedList=function(a,b){var d=!1;return b=b||this.oftenUsedMenuList,c.each(b,function(b,c){if(c.menuId===a)return d=!0,!1}),d},b.prototype.isInRecentUsedList=function(a){return this._isInOftenUsedList(a,this.recentUsedMenuList)},b.prototype.save=function(a){var b,e="",f="";return c.each(this.recentUsedMenuList,function(a,b){b&&b.hasOwnProperty("menuId")&&(e+=b.menuId+",")}),e.indexOf(",")!==-1&&(e=e.substring(0,e.length-1)),c.each(this.oftenUsedMenuList,function(a,b){var c,d;b&&b.hasOwnProperty("menuId")&&(c=b.menuId,d=b.count||1,f+="'"+c+"':"+d+",")}),f.indexOf(",")!==-1&&(f="{"+f.substring(0,f.length-1)+"}"),e&&f?(b={recent:e,often:f},void c.ajax({url:this.opts.saveUsedMenuUrl,data:b,async:!a}).done(function(a){a&&a.success?console.info("侧边栏数据保存成功"):d.alert("侧边栏数据保存失败：服务器内部错误。",{icon:2})})):void console.error("侧边栏数据有问题。")},b.prototype._sortOftenUsedMenuList=function(){this.oftenUsedMenuList.sort(function(a,b){var c=a.count||1,d=b.count||1;return d-c})},b});