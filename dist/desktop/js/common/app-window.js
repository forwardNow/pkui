define(function(a){function b(a){this.appInstance=null,this.options=null,this.artDialog=null,this.title=null,this.content=null,this._init(a)}var c,d,e,f,g,h,i,j=a("./menuSource");return c=a("jquery"),d=a("./dialog"),e=a("artTemplate"),f=a("../../tpl/desktop/appWindow.html"),g=e.compile(f),h=a("../../tpl/desktop/appWindowMain.html"),i=e.compile(h),a("isLoading"),b.prototype.defaults={icon:"",title:"",src:"",isMaxOnInit:!0,hasSidebar:!0,width:600,height:400,content:"<i class='pkui-content-loading-ring'></i>"},c.extend(b.prototype,{create:function(){var a,c;return a=this,a.artDialog=d.create({appendTo:"#da",title:a.title,content:a.content,url:"iframe"===this.options.mode?this.options.src:null,width:a.options.width,height:a.options.height,onclose:function(){a.appInstance.appDock.hide()},oniframeload:function(){a.artDialog.options.pkuiOptions.$dialogContent.children(".pkui-content-loading-ring").remove()}}),"iframe"===this.options.mode&&a.artDialog.options.pkuiOptions.$dialogContent.append(b.prototype.defaults.content),this.artDialog.show(),this.artDialog.__center(),this.options.isMaxOnInit&&(c=this.artDialog.options.pkuiOptions,c.$dialogContainer.stop(),c.$maxBtn.trigger("click.window.app")),this},show:function(){return this.artDialog.show(),this},hide:function(){this.artDialog.close()},destroy:function(){return this.artDialog&&this.artDialog.remove(),this.appInstance&&(this.appInstance.isAppWindowDestroy=!0),this.options=null,this.title=null,this.content=null,this.appInstance=null,this}}),c.extend(b.prototype,{_init:function(a){return this.options=c.extend({},this.defaults,a),this.title=this._getTitle(),"default"===this.options.mode&&(this.content=this._getContent()),this.create(),this._bindEvent(),this},_getTitle:function(){var a,b,c;return a=this.options.icon||"",c=this.options.title||"",b=a.indexOf("fa fa-")!==-1?'<i class="pkui-dialog-title-fonticon '+a+'"></i>':'<img class="pkui-dialog-title-icon" src="'+a+'">',b+c},_getContent:function(){var a,b,d,e,f;return a=this,d=this.options.src,b=this.options.menuId,"string"==typeof b&&(b='"'+b+'"'),e=g({menuId:b,menuUrl:j.opts.url}),c.ajax({type:"GET",cache:!1,dataType:"text",url:d}).done(function(b){var d,g,h,i;f=b,g=c("<div>"),g.append(e).find(".win-main-body").html(f),d=g.html(),a.options.content=d,a.artDialog.content(d),i=a.artDialog.options.pkuiOptions.$dialogContainer.find(".da-win-sidebar"),i.children('[data-pkui-component="menuTree"]').one("ready.jstree",function(){h=i.find(".jstree-anchor"),1===h.size()&&i.data("isHideWhenThereIsOnlyOneNode")&&(i.next(".da-win-sidebar-toggle").trigger("click"),i.closest(".da-win").addClass("only-one-node"),window.setTimeout(function(){h.eq(0).trigger("click")},360))}),g=null}).fail(function(b){var c="["+b.status+"]"+b.statusText;a.artDialog.content(c),console.error(c)}),this.options.content},_bindEvent:function(){var a,b=this.artDialog.options.pkuiOptions;return a=this,this.artDialog.addEventListener("remove",function(){a.artDialog=null,a.appInstance&&!a.appInstance.isAppDestroy&&a.appInstance.destroy()}),b.$dialogContainer.on("mousedown.dock.app",function(){a.appInstance.show()}),b.$dialogContainer.on("click.sidebar",".da-win-sidebar-toggle",function(){c(this).children(".fa").toggleClass("fa-indent"),b.$dialogContainer.find(".da-win").toggleClass("collapsed")}),b.$dialogContainer.on("click.sidebar.anchor",".da-win-sidebar .jstree-anchor",function(a){var d,e,f,g,h,j=c(this);a.preventDefault(),h=j.attr("href"),h.indexOf("/")!==-1&&(d=j.attr("menuicon"),e=j.text(),f=c(d.indexOf(".png")!==-1?i({menuicon:"",title:e,menuiconStyle:"background-image: url("+d+")"}):i({menuicon:d,title:e})),b.$dialogContainer.find(".da-win-main").replaceWith(f),g=f.children(".win-main-body"),g.isLoading(),c.ajax({type:"GET",cache:!1,dataType:"text",url:h}).done(function(a){g.html(a)}).fail(function(a){var b="["+a.status+"]"+a.statusText;g.html(b),console.error(b)}).always(function(){g.isLoading("hide")}))}),this}}),b});