define(function(a){function b(a){this.opts=c.extend(!0,{},this.defaults,a),this.init()}var c=a("jquery"),d=window.layer,e=window.PKUI,f=e.ctxPath,g=a("menutree");return b.prototype.defaults={treeSelector:"#sysMenuTree",createSysMenuButtonSelector:"#createSysMenuButton",editSysMenuButtonSelector:"#editSysMenuButton",deleteSysMenuButtonSelector:"#deleteSysMenuButton",refreshSysMenuTreeButtonSelector:"#refreshSysMenuTreeButton",saveSysMenuTreeButtonSelector:"#saveSysMenuTreeButton",displayAreaSelector:"#sysMenuDisplayArea"},b.prototype.init=function(){this.render(),this.initCache(),this.bind()},b.prototype.render=function(){var a=this.opts;this.$tree=c(a.treeSelector),this.$createSysMenuButton=c(a.createSysMenuButtonSelector),this.$editSysMenuButton=c(a.editSysMenuButtonSelector),this.$deleteSysMenuButton=c(a.deleteSysMenuButtonSelector),this.$refreshSysMenuTreeButton=c(a.refreshSysMenuTreeButtonSelector),this.$saveSysMenuTreeButton=c(a.saveSysMenuTreeButtonSelector),this.$displayArea=c(a.displayAreaSelector)},b.prototype.initCache=function(){this.newNodeCache={},this.defaultNode={icon:"fa fa-question",text:"请编辑并保存！"},this.modifiedNodeCache={}},b.prototype.bind=function(){function a(a,c){var d=c.data.origin,e=c.data.nodes,f=d.get_node(e[0],!0);f.is(b.opts.treeSelector+" .jstree-node")&&b.sortSysMenu()}var b=this;this.$tree.off("select_node.jstree").on("select_node.jstree",function(a,d){var g,h,i,j,k=d.node.data,l=d.node.id;return c.isArray(l)&&(l=l[0]),b.newNodeCache[l]===!0?(g=b.$tree,h=g.jstree(!0),i=h.get_node(l,!0),j=g.find(".jstree-node"),void b.editSysMenu(j.index(i))):void e.component.Template.getModelAndView(f+"/static/desktop/tpl/system/menu/detail.html",k,function(a){b.$displayArea.html(a)},{escape:!1})}),c(document).off("dnd_stop.vakata",a).on("dnd_stop.vakata",a),this.$createSysMenuButton.off("click.sysmenu").on("click.sysmenu",function(){b.createSysMenu()}),this.$editSysMenuButton.off("click.sysmenu").on("click.sysmenu",function(){b.editSysMenu()}),this.$deleteSysMenuButton.off("click.sysmenu").on("click.sysmenu",function(){b.deleteSysMenu()}),this.$saveSysMenuTreeButton.off("click.sysmenu").on("click.sysmenu",function(){b.saveSysMenuTree()}),this.$refreshSysMenuTreeButton.off("click.sysmenu").on("click.sysmenu",function(){b.refreshSysMenuTree()})},b.prototype.createSysMenu=function(){var a,b,e,f,g=this.$tree,h=g.jstree(!0),i=h.get_selected(),j=this.newNodeCache;if(this.hasUnsavedSysMenu())return void d.alert("请先编辑（保存）已新建菜单，或将其删除。",{icon:0});if(f=c.extend(!0,{id:"newNode_"+(new Date).getTime()},this.defaultNode),i.length){b=i[0],a=h.get_node(b);var k=a.original;f.menuId=k.menuId,f.sysId=k.sysId,f.sysName=k.sysName,e=h.create_node(b,f)}else e=h.create_node("#",f);j[e]=!0,h.deselect_node(i),h.select_node([e])},b.prototype.editSysMenu=function(a){var b,g,h=this,i=this.$tree,j=i.jstree(!0),k=j.get_selected(),l=this.newNodeCache;return 0===k.length?void d.msg("请选择菜单项！",{icon:0}):(b=j.get_node(k[0]),void(l[k[0]]===!0?(g=c.extend(!0,{},b.original),null!=a&&(g.orderFlag=a),e.component.Template.getModelAndView(f+"/static/desktop/tpl/system/menu/add.html",g,function(a){h.$displayArea.html(a)},{escape:!1})):(h.$displayArea.isLoading(),e.component.Template.getModelAndView(f+"/static/desktop/tpl/system/menu/edit.html","{% system.menu.list.js.sysMenuModel %}?menuId="+b.data.menuId,function(a){h.$displayArea.isLoading("hide"),h.$displayArea.html(a)},{escape:!1}))))},b.prototype.deleteSysMenu=function(){function a(){return i[g[0]]===!0?(f.delete_node(g[0]),delete i[g[0]],void d.msg("删除成功！",{icon:1})):(b=f.get_node(g[0]),h.isLoading({position:"insideButton"}),void c.ajax({url:"{% system.menu.list.js.sysMenuDelete %}",data:{menuId:b.data.menuId}}).done(function(a){a.success?(d.msg("删除成功！",{icon:1}),f.delete_node(g[0]),delete j[g[0]]):d.msg("删除失败！",{icon:2})}).fail(function(){d.msg("网络错误！",{icon:0})}).always(function(){h.isLoading("hide")}))}var b,e=this.$tree,f=e.jstree(!0),g=f.get_selected(),h=this.$deleteSysMenuButton,i=this.newNodeCache,j=this.modifiedNodeCache;return 0===g.length?void d.msg("请选择菜单项！",{icon:0}):void d.confirm("是否删除？",{icon:0,btn:["删除","取消"]},function(b){a(),d.close(b)},function(){})},b.prototype.saveSysMenuTree=function(){var a,b,e=this,f=this.$saveSysMenuTreeButton,g=[],h=this.modifiedNodeCache;for(a in h)h.hasOwnProperty(a)&&(b=h[a].modifiedProperties,b&&g.push(b));0!==g.length&&(f.isLoading({position:"insideButton"}),c.ajax({url:"{% system.menu.list.js.sysMenuSave %}",data:{sysMenuList:JSON.stringify(g)}}).done(function(a){a.success?(d.msg("修改成功！",{icon:1}),h={},e.refreshSysMenuTree()):d.msg("修改失败！",{icon:2})}).fail(function(){d.msg("网络错误！",{icon:0})}).always(function(){f.isLoading("hide")}))},b.prototype.refreshSysMenuTree=function(){var a=this.$tree,b=a.jstree(!0);b.destroy(),g.cache={},a.data("pkui.menutree",null).removeAttr("isrendered"),this.$displayArea.html(""),this.init()},b.prototype.sortSysMenu=function(){var a,b=this,d=this.$tree,e=d.jstree(!0);a=d.find(".jstree-node[role='treeitem']"),e.open_all(),a.each(function(a,d){var f,g=d.id,h=e.get_node(g),i=e.get_parent(g),j=e.get_node(i),k=h.data,l=j.data,m=b.modifiedNodeCache,n=m[i],o=!1;null!=k&&(f={menuId:k.menuId},"#"===i&&(l={treeLevel:0,menuId:-1}),n&&"moved"===n.nodestatus&&(l=c.extend(!0,{},l,n.modifiedProperties)),k.treeLevel!==l.treeLevel+1?(o=!0,f.treeLevel=l.treeLevel+1,f.treeParentid=l.menuId,f.orderFlag=a):k.treeParentid!=l.menuId?(o=!0,f.treeParentid=l.menuId,f.orderFlag=a):k.orderFlag!==a&&(o=!0,f.orderFlag=a),o&&(b.modifiedNodeCache[g]={nodestatus:"moved",modifiedProperties:f}))})},b.prototype.hasUnsavedSysMenu=function(){var a,b=!1,c=this.newNodeCache;for(a in c)c.hasOwnProperty(a)&&c[a]===!0&&(b=!0);return b},b});