define(function(a){"use strict";function b(a){this._init(a)}var c=a("jquery"),d=window.layer,e=window.PKUI,f="pkui.sysrole.content";return a("jstree"),b.namespace=f,b.prototype.defaults={containerSelector:"#sysrole-container",sysRoleContentSelector:"#sysroleContent",sysRoleTablistSelector:"#sysRoleTablist",sysRoleUserRoleIdFieldSelector:"#sysRoleUser-roleId",sysRoleUserTabpanelSelector:"#sysroleRelUser",sysRoleUserDatagridReloadBtnSelector:"#sysRoleUserDatagrid-reloadBtn",sysRoleUserAddUserBtnSelector:"#sysRoleUser-addBtn",sysRoleUserRemoveUserBtnSelector:"#sysRoleUser-removeBtn",sysRoleUserDatagridSelector:"#sysRoleUserDatagrid",sysRoleMenuTabpanelSelector:"#sysroleRelMenu",sysRoleMenuTreeContainerSelector:"#sysroleRelMenu-treeContainer",sysRoleMenuSaveBtnSelector:"#sysroleRelMenu-saveBtn",sysRoleResourceTabpanelSelector:"#sysroleRelResource",sysRoleResourceTreeContainerSelector:"#sysroleRelResource-treeContainer",sysRoleResourceSaveBtnSelector:"#sysroleRelResource-saveBtn",sysRolePermitTabpanelSelector:"#sysroleRelPermit",sysRolePermitTreeContainerSelector:"#sysroleRelPermit-treeContainer",sysRolePermitSaveBtnSelector:"#sysroleRelPermit-saveBtn",sysRoleNewPermitTabpanelSelector:"#sysroleRelNewPermit",sysRoleNewPermitTableSelector:"#sysroleRelNewPermit-table",sysRoleNewPermitSaveBtnSelector:"#sysroleRelNewPermit-saveBtn",sysRoleNewPermitAddNewRowBtnSelector:"#sysroleRelNewPermit-addNewRow",sysRoleNewPermitRemoveUnusedRowBtnSelector:"#sysroleRelNewPermit-removeUnusedRow",sysRoleNewPermitTemplate:{row:"<tr> <td></td> <td></td> <td></td> </tr>",deleteBtn:'<button type="button" class="btn btn-danger-2 js--deleteRow"><i class="fa fa-trash"></i></button>',select:'<select name="_newpermitSelect" data-pkui-component="chosen" data-pkui-component-options=\'{ "data": null }\'></select>',singleValueInput:'<input type="text" class="da-form-control">',doubleValueInput:'<div class="input-group">    <span class="input-group-addon">最小值</span>    <input type="text" class="da-form-control"></div><div class="input-group">    <span class="input-group-addon">最大值</span>    <input type="text" class="da-form-control"></div>'}},b.init=function(a){return new b(a)},b.prototype._init=function(a){this.opts=c.extend(!0,{},this.defaults,a),this._render(),this._bind()},b.prototype._render=function(){var a=this.opts;this.$container=c(a.containerSelector),this.$sysroleContent=c(a.sysRoleContentSelector),this.$tablist=c(a.sysRoleTablistSelector),this.$sysRoleUserRoleIdField=c(a.sysRoleUserRoleIdFieldSelector),this.$sysRoleUserTabpanel=c(a.sysRoleUserTabpanelSelector),this.$sysRoleUserDatagridReloadBtn=c(a.sysRoleUserDatagridReloadBtnSelector),this.$sysRoleUserAddUserBtn=c(a.sysRoleUserAddUserBtnSelector),this.$sysRoleUserRemoveUserBtn=c(a.sysRoleUserRemoveUserBtnSelector),this.$sysRoleUserDatagrid=c(a.sysRoleUserDatagridSelector),this.$sysRoleMenuTabpanel=c(a.sysRoleMenuTabpanelSelector),this.$sysRoleMenuTreeContainer=c(a.sysRoleMenuTreeContainerSelector),this.$sysRoleMenuSaveBtn=c(a.sysRoleMenuSaveBtnSelector),this.$sysRoleResourceTabpanel=c(a.sysRoleResourceTabpanelSelector),this.$sysRoleResourceTreeContainer=c(a.sysRoleResourceTreeContainerSelector),this.$sysRoleResourceSaveBtn=c(a.sysRoleResourceSaveBtnSelector),this.$sysRolePermitTabpanel=c(a.sysRolePermitTabpanelSelector),this.$sysRolePermitTreeContainer=c(a.sysRolePermitTreeContainerSelector),this.$sysRolePermitSaveBtn=c(a.sysRolePermitSaveBtnSelector),this.$sysRoleNewPermitTabpanel=c(a.sysRoleNewPermitTabpanelSelector),this.$sysRoleNewPermitTable=c(a.sysRoleNewPermitTableSelector),this.$sysRoleNewPermitSaveBtn=c(a.sysRoleNewPermitSaveBtnSelector),this.$sysRoleNewPermitAddNewRowBtn=c(a.sysRoleNewPermitAddNewRowBtnSelector),this.$sysRoleNewPermitRemoveUnusedRowBtn=c(a.sysRoleNewPermitRemoveUnusedRowBtnSelector);var b=a.sysRoleNewPermitTemplate;b.select=b.select.replace("null",window.JSON.stringify(this.$sysRoleNewPermitTable.data("options").selectControlData))},b.prototype._bind=function(){function a(a,e){function f(){var e="",f=b.$sysRoleUserTabpanel.attr("roleid"),i=a.data("options").url;a.isLoading({position:"insideButton"}),c.each(h,function(a,b){a>=0&&(e+="&"),e+="userId="+b}),e="roleId="+f+e,c.ajax({url:i,data:e}).done(function(a){if(a.success)d.msg(a.message||"操作成功！",{icon:1}),g.bootgrid("deleteRow",h);else{var b="操作失败："+(a.message||"未知的错误");d.alert(b,{icon:2}),console.error(b)}}).fail(function(){var a="操作失败：网络错误/登陆失效！";d.alert(a,{icon:0}),console.error(a)}).always(function(){a.isLoading("hide")})}var g,h;if(!a.attr("disabled"))return g=b.$sysRoleUserDatagrid,h=g.bootgrid("getSelectedRows"),0===h.length?void d.msg("请选中一条或多条记录进行操作！",{icon:0}):void d.confirm("请确认您的操作？",{btn:["确认","取消"]},function(a){f(),d.close(a)},function(){})}var b=this;this.$tablist.on("click."+f,"a",function(a){var d=c(this),e=d.parent(),g=d.attr("href");a.preventDefault(),e.addClass("active").siblings().removeClass("active"),c(g).addClass("active").siblings().removeClass("active"),b.$container.trigger("show."+f,g)}),this.$sysroleContent.on("click."+f,"input[name=roleIdOper]",function(){var a,d,e=c(this);e.is(".checked")||(a=b.$sysRoleUserAddUserBtn,d=b.$sysRoleUserRemoveUserBtn,c(".roleIdOper").removeClass("checked"),e.addClass("checked"),"in"===c(this).val()?(a.addClass("hidden"),d.removeClass("hidden")):(d.addClass("hidden"),a.removeClass("hidden")),b.$sysRoleUserDatagridReloadBtn.trigger("click"))}),b.$container.on("show."+f,function(a,c){var d,e,f,g;c===b.opts.sysRoleUserTabpanelSelector?(f=b.$sysRoleUserTabpanel,g="drawRoleUser"):c===b.opts.sysRoleMenuTabpanelSelector?(f=b.$sysRoleMenuTabpanel,g="drawRoleMenu"):c===b.opts.sysRoleResourceTabpanelSelector?(f=b.$sysRoleResourceTabpanel,g="drawRoleResource"):c===b.opts.sysRolePermitTabpanelSelector?(f=b.$sysRolePermitTabpanel,g="drawRolePermit"):c===b.opts.sysRoleNewPermitTabpanelSelector&&(f=b.$sysRoleNewPermitTabpanel,g="drawRoleNewPermit"),d=f.attr("roleid"),e=f.attr("draw-for-roleid"),void 0!==d&&d!==e&&b[g](d)}),this.$sysRoleUserAddUserBtn.on("click."+f,function(){a(c(this),"add")}),this.$sysRoleUserRemoveUserBtn.on("click."+f,function(){a(c(this),"remove")}),this.$sysRoleMenuSaveBtn.on("click."+f,function(){var a,e,f=c(this),g=f,h=b.$sysRoleMenuTreeContainer.jstree(!0),i=f.data("options"),j=[],k="";h&&(a=h.get_selected(!0),c.each(a,function(a,b){b&&j.push(b.original.menuId)}),g.isLoading({position:"insideButton"}),c.each(j,function(a,b){a>=0&&(k+="&"),k+="menuId="+b}),e=b.$sysRoleMenuTabpanel.attr("roleid"),c.ajax({url:i.url,data:"roleId="+e+k}).done(function(a){if(a.success)d.msg(a.message||"[菜单权限]保存成功！",{icon:1});else{var b="[菜单权限]保存失败："+(a.message||"未知的错误");d.alert(b,{icon:2}),console.error(b)}}).fail(function(){d.alert("[菜单权限]保存失败：网络错误/登陆失效！",{icon:0}),console.error("[菜单权限]保存失败：网络错误/登陆失效！")}).always(function(){g.isLoading("hide")}))}),this.$sysRoleResourceSaveBtn.on("click."+f,function(){var a,e,f=c(this),g=f,h=b.$sysRoleResourceTreeContainer.jstree(!0),i=f.data("options"),j=[],k="";h&&(a=h.get_selected(!0),c.each(a,function(a,b){b&&b.original.menuId!==!1&&j.push(b.original.resourceId)}),g.isLoading({position:"insideButton"}),c.each(j,function(a,b){a>=0&&(k+="&"),k+="resourceId="+b}),e=b.$sysRoleResourceTabpanel.attr("roleid"),c.ajax({url:i.url,data:"roleId="+e+k}).done(function(a){if(a.success)d.msg(a.message||"[资源权限]保存成功！",{icon:1});else{var b="[资源权限]保存失败："+(a.message||"未知的错误");d.alert(b,{icon:2}),console.error(b)}}).fail(function(){d.alert("[资源权限]保存失败：网络错误/登陆失效！",{icon:0}),console.error("[资源权限]保存失败：网络错误/登陆失效！")}).always(function(){g.isLoading("hide")}))}),this.$sysRolePermitSaveBtn.on("click."+f,function(){var a,e,f=c(this),g=f,h=b.$sysRolePermitTreeContainer.jstree(!0),i=f.data("options"),j=[],k="";h&&(a=h.get_selected(!0),c.each(a,function(a,b){b&&b.original.permitCode!==!1&&j.push(b.original.permitId)}),g.isLoading({position:"insideButton"}),c.each(j,function(a,b){a>=0&&(k+="&"),k+="permitId="+b}),e=b.$sysRolePermitTabpanel.attr("roleid"),c.ajax({url:i.url,data:"roleId="+e+k}).done(function(a){if(a.success)d.msg(a.message||"[数据权限]保存成功！",{icon:1});else{var b="[数据权限]保存失败："+(a.message||"未知的错误");d.alert(b,{icon:2}),console.error(b)}}).fail(function(){d.alert("[数据权限]保存失败：网络错误/登陆失效！",{icon:0}),console.error("[数据权限]保存失败：网络错误/登陆失效！")}).always(function(){g.isLoading("hide")}))}),this.$sysRoleNewPermitAddNewRowBtn.on("click."+f,function(){var a=b.opts.sysRoleNewPermitTemplate,d=b.$sysRoleNewPermitTable.find("tbody"),f=c(a.row),g=c(a.deleteBtn),h=c(a.select),i=c(a.singleValueInput);f.children().eq(0).append(g).end().eq(1).append(h).end().eq(2).append(i),d.append(f),e.render()}),this.$sysRoleNewPermitTable.on("click."+f,".js--deleteRow",function(a,b){var e=this;return b?void c(e).closest("tr").remove():void d.confirm("确定删除该条数据",{btn:["删除","取消"]},function(a){c(e).closest("tr").remove(),d.close(a)},function(){})}),this.$sysRoleNewPermitTable.on("change."+f,"select",function(){var a=c(this),d=a.val(),e=a.closest("tr").children().eq(2),f=e.find("input"),g=f.size(),h=b.opts.sysRoleNewPermitTemplate;"between"===d&&1===g?e.html(h.doubleValueInput):"between"!==d&&2===g&&e.html(h.singleValueInput)}),this.$sysRoleNewPermitSaveBtn.on("click."+f,function(){var a,e=c(this),g=[],h=b.$sysRoleNewPermitSaveBtn.data("options").url;b.$sysRoleNewPermitRemoveUnusedRowBtn.trigger("click."+f),b.$sysRoleNewPermitTable.find("tbody").children("tr").each(function(){var a,b,d,e,f=c(this),h=f.children().eq(1).find("select"),i=f.children().eq(2).find("input");a=h.val(),b=i.eq(0).val(),e={operator:a,value:b.replace(/%/g,"%25").replace(/&/g,"%26").replace(/\+/g,"%2B")},"between"===a&&(d=i.eq(1).val(),e.value2=d.replace(/%/g,"%25").replace(/&/g,"%26").replace(/\+/g,"%2B")),g.push(e)}),e.isLoading({position:"insideButton"}),a=b.$sysRoleNewPermitTabpanel.attr("roleid"),c.ajax({url:h,data:"roleId="+a+"&data="+window.JSON.stringify(g)}).done(function(c){if(c.success)d.msg(c.message||"[数据权限]保存成功！",{icon:1}),b.drawRoleNewPermit(a);else{var e="[数据权限]保存失败："+(c.message||"未知的错误");d.alert(e,{icon:2}),console.error(e)}}).fail(function(){d.alert("[数据权限]保存失败：网络错误/登陆失效！",{icon:0}),console.error("[数据权限]保存失败：网络错误/登陆失效！")}).always(function(){e.isLoading("hide")})}),this.$sysRoleNewPermitRemoveUnusedRowBtn.on("click."+f,function(){b.$sysRoleNewPermitTable.find(".da-form-control").each(function(){var a=c(this);""===a.val()&&a.closest("tr").remove()})})},b.prototype.draw=function(){},b.prototype.redraw=function(a){this.redrawRoleUser(a),this.redrawRoleMenu(a),this.redrawRolePermit(a),this.redrawRoleResource(a),this.redrawRoleNewPermit(a)},b.prototype.redrawRoleUser=function(a){this.$sysRoleUserRoleIdField.val(a),this.$sysRoleUserTabpanel.attr("roleid",a),this.$sysRoleUserTabpanel.is(".active")&&this.drawRoleUser(a)},b.prototype.drawRoleUser=function(a){this.$sysRoleUserDatagridReloadBtn.trigger("click"),this.$sysRoleUserTabpanel.attr("draw-for-roleid",a)},b.prototype.redrawRoleMenu=function(a){this.$sysRoleMenuTabpanel.attr("roleid",a),this.$sysRoleMenuTabpanel.is(".active")&&this.drawRoleMenu(a)},b.prototype.drawRoleMenu=function(a){function b(a){var b,c,d,g={};b=a.data,c=e(b,i),d=window.PKUI.getTreeList({data:c,rootId:i.menuId,idName:"menuId",parentIdName:"treeParentid",childrenName:"children"}),g.core={data:d,dblclick_toggle:i.jstreeOptions.dblclick_toggle,worker:!1,multiple:!0,themes:{dots:!0},check_callback:!0},g.checkbox={keep_selected_style:!1},g.plugins=["checkbox"],f.jstree(g)}function e(a,b){var d=[],e="jstree_"+(new Date).getTime()+"_",f=b.jstreeOptions;return c.each(a,function(a,b){var g=b.icon||"fa fa-file-o";d.push(b),g&&g.indexOf(".png")!==-1&&(g=window.PKUI.iconPath+"/24x24/"+g),b.data=c.extend(!0,{},b),b.a_attr={href:"javascript:void(0)",menuicon:g},b.id=e+b.menuId,b.text=b.menuName,b.icon=g,b.state={opened:f.openAll,selected:"checked"===b.checked}}),d}var f=this.$sysRoleMenuTreeContainer,g=this.$sysRoleMenuTabpanel,h=f.jstree(!0),i=f.data("options"),j=i.url;h&&h.destroy(),g.isLoading(),c.ajax({url:j,data:{roleId:a}}).done(function(a){var c;return a&&a.success!==!1&&null!==a.data&&void 0!==a.data?void b(a):(c=a&&a.message||"菜单权限树构建失败！",d.msg(c,{icon:2}),void console.error(c))}).fail(function(a){var b="菜单权限树构建失败："+a.status+" ("+a.statusText+")";d.msg(b,{icon:0}),console.error(b)}).always(function(){g.isLoading("hide")}),g.attr("draw-for-roleid",a)},b.prototype.redrawRoleResource=function(a){this.$sysRoleResourceTabpanel.attr("roleid",a),this.$sysRoleResourceTabpanel.is(".active")&&this.drawRoleResource(a)},b.prototype.drawRoleResource=function(a){function b(a){var b,d,g=[],h={},j=[],k=[],l={};b=a.data,c.each(b,function(a,b){b&&j.push(b.menuId)}),c.unique(j),d=e(b,i),c.each(d,function(a,b){var c=b.menuId;null!==c&&(l[c]||(l[c]=[]),l[c].push(b))}),c.each(j,function(a,b){k.push({resourceId:"menuId_"+b,resourceDesc:l[b][0].menuName,menuId:!1,_menuId:b})}),k=e(k,i),c.each(k,function(a,b){var c=b;c.children=l[b._menuId],g.push(c)}),h.core={data:g,dblclick_toggle:i.jstreeOptions.dblclick_toggle,worker:!1,multiple:!0,themes:{dots:!0},check_callback:!0},h.checkbox={keep_selected_style:!1},h.plugins=["checkbox"],f.jstree(h)}function e(a,b){var d=[],e="jstree_"+(new Date).getTime()+"_",f=b.jstreeOptions;return c.each(a,function(a,b){var g="fa fa-file-o";d.push(b),b.data=c.extend(!0,{},b),b.a_attr={href:"javascript:void(0)",menuicon:g},b.id=e+b.resourceId,b.text=b.resourceDesc,b.icon=g,b.state={opened:f.openAll,selected:"checked"===b.checked}}),d}var f=this.$sysRoleResourceTreeContainer,g=this.$sysRoleResourceTabpanel,h=f.jstree(!0),i=f.data("options"),j=i.url;h&&h.destroy(),g.isLoading(),c.ajax({url:j,data:{roleId:a}}).done(function(a){var c;return a&&a.success!==!1&&null!==a.data&&void 0!==a.data?void b(a):(c=a&&a.message||"资源权限构建失败！",d.msg(c,{icon:2}),void console.error(c))}).fail(function(a){var b="资源权限构建失败："+a.status+" ("+a.statusText+")";d.msg(b,{icon:0}),console.error(b)}).always(function(){g.isLoading("hide")}),g.attr("draw-for-roleid",a)},b.prototype.redrawRolePermit=function(a){this.$sysRolePermitTabpanel.attr("roleid",a),this.$sysRolePermitTabpanel.is(".active")&&this.drawRolePermit(a)},b.prototype.drawRolePermit=function(a){function b(a){var b,d,g=[],h={},j=[],k=[],l={};b=a.data,c.each(b,function(a,b){b&&j.push(b.permitCode)}),c.unique(j),d=e(b,i),c.each(d,function(a,b){var c=b.permitCode;null!==c&&(l[c]||(l[c]=[]),l[c].push(b))}),c.each(j,function(a,b){k.push({permitId:"permitCode_"+b,permitName:l[b][0].permitCodeDesc,permitCode:!1,_permitCode:b})}),k=e(k,i),c.each(k,function(a,b){var c=b;c.children=l[b._permitCode],g.push(c)}),h.core={data:g,dblclick_toggle:i.jstreeOptions.dblclick_toggle,worker:!1,multiple:!0,themes:{dots:!0},check_callback:!0},h.checkbox={keep_selected_style:!1},h.plugins=["checkbox"],f.jstree(h)}function e(a,b){var d=[],e="jstree_"+(new Date).getTime()+"_",f=b.jstreeOptions;return c.each(a,function(a,b){var g="fa fa-file-o";d.push(b),b.data=c.extend(!0,{},b),b.a_attr={href:"javascript:void(0)",menuicon:g},b.id=e+b.permitId,b.text=b.permitName,b.icon=g,b.state={opened:f.openAll,selected:"checked"===b.checked}}),d}var f=this.$sysRolePermitTreeContainer,g=this.$sysRolePermitTabpanel,h=f.jstree(!0),i=f.data("options"),j=i.url;h&&h.destroy(),g.isLoading(),c.ajax({url:j,data:{roleId:a}}).done(function(a){var c;return a&&a.success!==!1&&null!==a.data&&void 0!==a.data?void b(a):(c=a&&a.message||"数据权限构建失败！",d.msg(c,{icon:2}),void console.error(c))}).fail(function(a){var b="数据权限构建失败："+a.status+" ("+a.statusText+")";d.msg(b,{icon:0}),console.error(b)}).always(function(){g.isLoading("hide")}),g.attr("draw-for-roleid",a)},b.prototype.redrawRoleNewPermit=function(a){this.$sysRoleNewPermitTabpanel.attr("roleid",a),this.$sysRoleNewPermitTabpanel.is(".active")&&this.drawRoleNewPermit(a)},b.prototype.drawRoleNewPermit=function(a){var b=this,e=b.$sysRoleNewPermitTabpanel,f=b.$sysRoleNewPermitTable.find("tbody");e.isLoading(),c.ajax({url:b.$sysRoleNewPermitTable.data("options").url,data:{roleId:a}}).done(function(a){var e="";if(a.success||a.data)c.each(a.data,function(a,c){var d,f,g,h;c&&(d=c.operator,f=c.value,g=c.value2,h="between"===d&&void 0!==g?'<tr>    <td title="删除此条数据后，需要点击“保存”。">'+b.opts.sysRoleNewPermitTemplate.deleteBtn+"</td>    <td>"+d+'        <select class="hidden">            <option value="'+d+'" selected></option>        </select>    </td>    <td>最小值：'+f+"。 最大值："+g+'。        <input type="text" class="da-form-control hidden" value="'+f+'">        <input type="text" class="da-form-control hidden" value="'+g+'">    </td></tr>':'<tr>    <td title="删除此条数据后，需要点击“保存”。">'+b.opts.sysRoleNewPermitTemplate.deleteBtn+"</td>    <td>"+d+'        <select class="hidden">            <option value="'+d+'" selected></option>        </select>    </td>    <td>'+f+'        <input type="text" class="da-form-control hidden" value="'+f+'">    </td></tr>',e+=h)}),f.html(e);else{var g="[数据权限]获取数据失败";d.alert(g,{icon:2}),console.error(g)}}).fail(function(){d.alert("[数据权限]获取数据失败",{icon:0}),console.error("[数据权限]获取数据失败")}).always(function(){e.isLoading("hide")})},b});