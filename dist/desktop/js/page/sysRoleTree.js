define(function(a){"use strict";function b(a){this.opts=c.extend(!0,{},this.defaults,a),this._init(a)}var c=a("jquery"),d=window.layer,e=a("template"),f="pkui.sysrole.tree";return a("jstree"),b.namespace=f,b.init=function(a){return new b(a)},b.prototype.defaults={containerSelector:"#sysrole-container",sysRoleTreeSelector:"#sysRoleTree",createSysRoleButtonSelector:"#createSysRoleButton",editSysRoleButtonSelector:"#editSysRoleButton",deleteSysRoleButtonSelector:"#deleteSysRoleButton",sysRoleTreeListSelector:"#sysrole-tree-list"},b.prototype._init=function(){var a=this;this._render(),this.draw(function(){a._bindTreeEvent()}),this._bind()},b.prototype._render=function(){var a=this.opts;this.$container=c(a.containerSelector),this.$sysRoleTree=c(a.sysRoleTreeSelector),this.$sysRoleTreeList=this.$sysRoleTree.find(a.sysRoleTreeListSelector),this.$createSysRoleButton=c(a.createSysRoleButtonSelector),this.$editSysRoleButton=c(a.editSysRoleButtonSelector),this.$deleteSysRoleButton=c(a.deleteSysRoleButtonSelector)},b.prototype.redraw=function(a){var b=this;this.draw(function(){b._bindTreeEvent(),void 0!==a&&null!==a&&b.$sysRoleTreeList.find('.jstree-anchor[roleid="'+a+'"]').trigger("click")})},b.prototype.draw=function(a){function b(a){var b=[],d="jstree_"+(new Date).getTime()+"_";return c.each(a,function(a,e){b.push(e),e.data=c.extend(!0,{},e),e.a_attr={href:"javascript:void(0)",roleid:e.roleId},e.id=d+e.roleId,e.text=e.roleName,e.icon="fa fa-vcard",e.state={opened:!0}}),b}function e(a){var b,d,e="jstree_"+(new Date).getTime()+"_",f={defaultGroup:[]},g=[];c.each(a,function(a,b){var c=b.sysId;null===c||void 0===c?f.defaultGroup.push(b):(void 0===f[c]&&(f[c]=[]),f[c].push(b))});for(b in f)d={id:e+b,icon:"fa fa-folder",state:{opened:!0},children:f[b]},"defaultGroup"===b?(d.text="未分类",d.data={sysId:null}):(d.text=f[b][0].sysName,d.data={sysId:b}),d.data.isRoot=!0,g.push(d);return g}var f=this,g=this.$sysRoleTree,h=this.$sysRoleTreeList.attr("data-list-url");g.isLoading(),c.ajax({url:h}).done(function(c){var g,h,i,j;c.success?(g=c.data,h=b(g),i=e(h),j=f.$sysRoleTreeList.jstree(!0),j&&j.destroy(),f.$sysRoleTreeList.jstree({core:{data:i,dblclick_toggle:!0,worker:!1,multiple:!1,themes:{dots:!0}},plugins:["search","wholerow"]}),a&&a()):d.msg("服务器端异常！",{icon:2})}).fail(function(){d.msg("获取角色失败，无法构建角色树！",{icon:0})}).always(function(){g.isLoading("hide")})},b.prototype._bindTreeEvent=function(){var a=this;a.$sysRoleTreeList.on("select_node.jstree",function(b,c){var d=c.node.data;!d.isRoot&&d.roleId&&a.$container.trigger("clickSysRoleTreeItem."+f,{roleId:d.roleId,roleName:d.roleName})})},b.prototype._bind=function(){var a=this;a.$createSysRoleButton.on("click."+f,function(){var b,c,d=a.$sysRoleTreeList.jstree(!0),e=d.get_selected();0===e.length||(b=d.get_node(e[0]),c=b.data),a._createSysRole(c)}),a.$editSysRoleButton.on("click."+f,function(){var b,c,e=a.$sysRoleTreeList.jstree(!0),f=e.get_selected();return 0===f.length?void d.msg("请选择角色！",{icon:0}):(b=e.get_node(f[0]),c=b.original,c.isRoot||void 0===c.roleId?void d.msg("此项无法进行编辑！",{icon:0}):void a._editSysRole(c))}),a.$deleteSysRoleButton.on("click."+f,function(){var b,c,e=a.$sysRoleTreeList.jstree(!0),f=e.get_selected();return 0===f.length?void d.msg("请选择角色！",{icon:0}):(b=e.get_node(f[0]),c=b.data,c.isRoot||void 0===c.roleId?void d.msg("此项无法删除！",{icon:0}):void d.confirm("是否删除角色["+c.roleName+"]？",{btn:["删除","取消"]},function(b){a._deleteSysRole(c),d.close(b)},function(){}))})},b.prototype._createSysRole=function(a){var b,c=this.$sysRoleTreeList.attr("data-view-url");a&&(a={sysId:a.sysId,orderFlag:a.orderFlag||10}),d.open({id:"editSysRoleLayer",title:"添加角色",type:1,skin:"layui-layer-rim",area:["600px","380px"],content:"",success:function(d){b=d.find(".layui-layer-content"),b.isLoading(),e.getModelAndView(c,a,function(a){b&&(b.isLoading("hide"),b.html(a))})},end:function(){b=null}})},b.prototype._editSysRole=function(a){var b,c=this.$sysRoleTreeList.attr("data-view-url"),f=this.$sysRoleTreeList.attr("data-model-url");f+="?roleId="+a.roleId,d.open({id:"editSysRoleLayer",title:"编辑角色—— "+a.roleName,type:1,skin:"layui-layer-rim",area:["600px","380px"],content:"",success:function(a){b=a.find(".layui-layer-content"),b.isLoading(),e.getModelAndView(c,f,function(a){b&&(b.isLoading("hide"),b.html(a))})},end:function(){b=null}})},b.prototype._deleteSysRole=function(a){var b=this,e=this.$sysRoleTreeList.attr("data-delete-url"),f=this.$deleteSysRoleButton,g=a.roleId,h=a.roleName;f.isLoading({position:"insideButton"}),c.ajax({url:e,data:{roleId:g}}).done(function(a){a.success?(d.msg(a.message||"删除角色["+h+"]成功！",{icon:1}),b.redraw()):d.alert("删除角色["+h+"]失败："+(a.message||"服务器内部错误。"),{icon:2})}).fail(function(){d.alert("删除角色["+h+"]失败：：网络错误/登陆失效。",{icon:0})}).always(function(){f.isLoading("hide")})},b});