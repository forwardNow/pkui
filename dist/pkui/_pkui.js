define(function(a){"use strict";a("isLoading"),a("css/font/font-awesome/4.7.0/font-awesome.css"),a("layer"),a("lib/component/layer/3.0.1.x/skin/default/layer.css"),a("moment-local-zh"),a("bootstrap-tooltip");var b=a("jquery"),c=a("meld"),d=a("moment"),e=a("artTemplate"),f=a("dataSource"),g=window["www.pkusoft.net"],h=b(window.document),i={componentHtmlAttr:"pkui-component",componentOptionsHtmlAttr:"pkui-component-options",ctxPath:g.ctxPath,basePath:g.pkuiBasePath,dicPath:g.ctxPath+"/static/dic/",timestamp:g.timestamp,component:{},isAutoRender:!0,__isrendering:!1,__renderedTimes:0};location.href.indexOf("localhost")!==-1&&g.pkuiBasePath.indexOf("static")===-1&&(i.ctxPath="http://localhost:8080/pkui",i.dicPath="http://localhost:8080/pkui/static/dic/"),i.console={info:function(a,b){console.info(a),b&&window.layer.msg(a)},warn:function(a,b){console.warn(a),b&&window.layer.msg(a)},error:function(a,b){console.error(a),b&&window.layer.msg(a)}},b.extend(i,{_init:function(){window.PKUI=i,this._registerComponent(),this._bindEvent(),this._modifyBrowserMethod(),this._setAjaxDefaultOptions(),this._convertCtxPath(),this._setTemplateHelper(),this._setBootgridFormatter(),this.setAutoRender(this.isAutoRender)},_registerComponent:function(){i.component.DataSource=f,f.init()},_bindEvent:function(){h.ready(i.render)},_modifyBrowserMethod:function(){window.__alert=window.alert,window.alert=window.layer.alert},_setAjaxDefaultOptions:function(){b.ajaxSetup({type:"POST",method:"POST",dataType:"json"})},_convertCtxPath:function(){var a=b.fn.html,c=b.ajax;b.ajax=function(a,b){return"string"==typeof a?a=a.replace(/.*__CTX__/,i.ctxPath):"object"==typeof a&&a.hasOwnProperty("url")&&(a.url=a.url.replace(/.*__CTX__/,i.ctxPath)),c.call(this,a,b)},b.fn.html=function(b){return void 0===b?a.call(this):("string"==typeof b&&(b=b.replace(/__CTX__/gm,i.ctxPath)),a.call(this,b))}},_setTemplateHelper:function(){e.helper("dicValue",function(a,b){return f.getDicValue(b,a)}),e.helper("dateFormat",function(a,b){return d(a).format(b)})},_setBootgridFormatter:function(){i.bootgridFormatter={dateFormatter:function(a,b){var c=b[a.id];return d(c).format("YYYY年MM月DD日")},datetimeFormatter:function(a,b){var c=b[a.id];return d(c).format("YYYY年MM月DD日 HH时mm分ss秒")},statusFormatter:function(a,b){var c=b[a.id];return"1"===c?'<span class="text-success"><i class="fa fa-circle"></i> 正常</span>':'<span class="text-danger"><i class="fa fa-circle"></i> 停用</span>'},yesOrNoFormatter:function(a,b){var c=b[a.id];return"1"===c?'<span class="text-success"><i class="fa fa-circle"></i> 是</span>':'<span class="text-danger"><i class="fa fa-circle"></i> 否</span>'}}},_addTooltip:function(){var a;this._isAddingTooltip||(this._isAddingTooltip=!0,a=b("[title]").not(function(){return!b.trim(b(this).attr("title"))}),a.bsTooltip({placement:"auto top"}),this._isAddingTooltip=!1)}}),b.extend(i,{load:seajs.use,render:function(){var a=b("[data-"+i.componentHtmlAttr+"]").not("[isrendered]").not("[notrecognized='not reg']");i._addTooltip();try{if(0===a.size())return;if(i.__isrendering)return void console.info(d().format("YYYY年MM月DD日 HH:MM:SS"),"正在渲染...");i.__isrendering=!0,i.__renderedTimes++,console.info(d().format("YYYY年MM月DD日 HH:MM:SS"),"渲染次数："+i.__renderedTimes),a.each(function(){var a,c=b(this),e=c.data(i.componentHtmlAttr),f=c.data(i.componentOptionsHtmlAttr)||{};""!==b.trim(e)&&(a=e.indexOf("|")!==-1?e.split("|"):[e],b.isArray(f)||(f=[f]),b.each(a,function(a,e){var g=f[a]||{},h=i.component[b.trim(e)],j=e;if(h)h.call(c,g);else{switch(e){case"datagrid":j="bootgrid";break;case"datagrid-delete":j="datagrid-delete";break;case"drawer":j="drawer";break;case"form":j="form";break;case"validator":j="validator";break;case"chosen":j="chosen";break;case"webuploader":j="webuploader";break;default:var k="未被注册的组件["+e+"]";return i.console.info(d().format("YYYY年MM月DD日 HH:MM:SS")+" "+k),window.layer.msg(k),void c.attr("notrecognized","not reg")}seajs.use([j],function(){i.component[b.trim(e)].call(c,g)})}}))})}catch(a){throw a}finally{i.__isrendering=!1}},setAutoRender:function(a){return 0===arguments.length?void console.info("/(ㄒoㄒ)/~~ 请设置参数。"):(i.isAutoRender=Boolean(a),void(a?i.setAutoRender.pointcutHandlerList=[c.after(b.prototype,"html",i.render)]:b.each(i.setAutoRender.pointcutHandlerList,function(a,b){b.remove()})))}}),b.extend(i,{handleJsonResult:function(a){return"string"==typeof a&&(a=b.parseJSON(a)),a},handleGridResult:function(a){return i.handleJsonResult(a)},getTreeList:function(a){function c(a){var d=[];return a&&a.length?(b.each(a,function(a,e){var f,g=e;f=b.extend({},g),f[k]=c(l[g[i]]),d.push(f)}),d):null}var d,e,f,g=a.data,h=a.rootId,i=a.idName||"id",j=a.parentIdName||"parentId",k=a.childrenName||"children",l={};return h||(h=g[0][i]),b.each(g,function(a,b){e=b[j],l[e]=l[e]||[],l[e].push(b)}),f=g[h],b.isArray(f)||(f=[f]),d=c(f)}}),i._init()});