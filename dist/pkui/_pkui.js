define(function(a){"use strict";a("isLoading"),a("css/font/font-awesome/4.7.0/font-awesome.css"),a("layer"),a("lib/component/layer/3.0.1.x/skin/default/layer.css"),a("moment-local-zh"),a("bootstrap-tooltip"),a("bootstrap-dropdown");var b=a("jquery"),c=a("placeholderHandler"),d=a("meld"),e=a("moment"),f=a("artTemplate"),g=a("dataSource"),h=window["www.pkusoft.net"],i=b(window.document),j={componentHtmlAttr:"pkui-component",componentOptionsHtmlAttr:"pkui-component-options",ctxPath:h.ctxPath,basePath:h.pkuiBasePath,iconPath:h.ctxPath+"/static/desktop/images/icon",dicPath:h.ctxPath+"/static/dic/",timestamp:h.timestamp,component:{},datagridDateFormat:"YYYY-MM-DD",datagridDatetimeFormat:"YYYY-MM-DD HH:mm:ss",isAutoRender:!0,__isrendering:!1,__renderedTimes:0};j.console={info:function(a,b){console.info(a),b&&window.layer.msg(a)},warn:function(a,b){console.warn(a),b&&window.layer.msg(a)},error:function(a,b){console.error(a),b&&window.layer.msg(a)}},b.extend(j,{_init:function(){window.PKUI=j,this._handleLowVersionIE(),this._registerComponent(),this._bindEvent(),this._modifyBrowserMethod(),this._setAjaxDefaultOptions(),this._convertCtxPath(),this._setTemplateHelper(),this._setBootgridFormatter(),this.setAutoRender(this.isAutoRender)},_handleLowVersionIE:function(){var a=document.createElement("div");a.innerHTML="<!--[if lt IE 8]><i></i><![endif]-->",a.getElementsByTagName("i").length>0&&b(document.body).append('<div class="alert alert-warning text-center" style="position:fixed; z-index: 99999; top: 0; left: 0; width: 100%;">很抱歉，您的IE浏览器版本过低，在您的使用过程中会带来一些不好的体验。建议您使用IE8及以上版本，或使用其他现代浏览器。</div>')},_registerComponent:function(){j.component.DataSource=g,g.init()},_bindEvent:function(){i.ready(j.render)},_modifyBrowserMethod:function(){window.__alert=window.alert,window.alert=window.layer.alert},_setAjaxDefaultOptions:function(){b.ajaxSetup({type:"POST",method:"POST",dataType:"json",error:function(a){var b="Ajax请求失败："+a.status+" ("+a.statusText+")。请刷新网页，如果依旧存在此提示，请联系管理员。";console.error(b)}})},_convertCtxPath:function(){function a(a){return"string"!=typeof a?(console.error("["+a+"] 不是字符串"),a):a.replace(/.*__CTX__/,j.ctxPath)}var d=b.fn.html,e=b.ajax;b.ajax=function(b,d){return"string"==typeof b?(b=c.process(b),b=a(b)):"object"==typeof b&&b.hasOwnProperty("url")&&(b.url=c.process(b.url),b.url=a(b.url)),e.call(this,b,d)},b.fn.html=function(a){return void 0===a?d.call(this):("string"==typeof a&&(a=c.process(a),a=a.replace(/__CTX__/gm,j.ctxPath)),d.call(this,a))}},_setTemplateHelper:function(){f.helper("dicValue",function(a,b){return g.getDicValue(b,a)}),f.helper("dateFormat",function(a,b){var c;return"number"==typeof a?c=e(a):"string"==typeof a&&(c=e(a,["YYYYMMDDHHmmss","YYYY-MM-DD HH:mm:ss","YYYY/MM/DD HH:mm:ss"])),b=b||"YYYY-MM-DD",c.format(b)}),f.helper("iconFormat",function(a,b){var c,d;return a?a.indexOf("fa-")!==-1?'<i class="'+a+'"></i>':a.indexOf(".png")!==-1?(b=parseInt(b)||24,d=j.iconPath+"/"+b+"x"+b+"/"+a,c="background-image: url("+d+"); width: "+b+"px; height: "+b+"px;",'<span class="pkui-icon-image" style="'+c+'"></span>'):"":""})},_setBootgridFormatter:function(){j.bootgridFormatter={dateFormatter:function(a,b){var c,d=b[a.id];return"number"==typeof d?c=e(d):"string"==typeof d&&(c=e(d,["YYYYMMDDHHmmss","YYYY-MM-DD HH:mm:ss","YYYY/MM/DD HH:mm:ss"])),c.format(j.datagridDateFormat)},datetimeFormatter:function(a,b){var c,d=b[a.id];return"number"==typeof d?c=e(d):"string"==typeof d&&(c=e(d,["YYYYMMDDHHmmss","YYYY-MM-DD HH:mm:ss","YYYY/MM/DD HH:mm:ss"])),c.format(j.datagridDatetimeFormat)},statusFormatter:function(a,b){var c=b[a.id];return"1"===c?'<span class="text-success"><i class="fa fa-circle"></i> 正常</span>':'<span class="text-danger"><i class="fa fa-circle"></i> 停用</span>'},yesOrNoFormatter:function(a,b){var c=b[a.id];return"1"===c?'<span class="text-success"><i class="fa fa-circle"></i> 是</span>':'<span class="text-danger"><i class="fa fa-circle"></i> 否</span>'}}},_addTooltip:function(){var a,c=4;this._isPending||(this._isPending=!0,a=b("[title]").not(function(){return!b.trim(b(this).attr("title"))}),a.bsTooltip({container:"body",delay:300,placement:"auto top"}),a.off("show.bs.tooltip").on("show.bs.tooltip",function(){var a=b(this),d=a.data("timeoutId");d&&window.clearTimeout(d),d=setTimeout(function(){a.bsTooltip("hide"),a.data("bs.tooltip")||b("body > .bs-tooltip").remove()},1e3*c),a.data("timeoutId",d)}).off("hide.bs.tooltip").on("hide.bs.tooltip",function(){var a=b(this),c=a.data("timeoutId");c&&window.clearTimeout(c)}),this._isPending=!1)}}),b.extend(j,{load:seajs.use,render:function(){var a=b("[data-"+j.componentHtmlAttr+"]").not("[isrendered]").not("[notrecognized='not reg']");j._addTooltip();try{if(0===a.size())return;if(j.__isrendering)return void console.info(e().format("YYYY年MM月DD日 HH:MM:SS"),"正在渲染...");j.__isrendering=!0,j.__renderedTimes++,console.info(e().format("YYYY年MM月DD日 HH:MM:SS"),"渲染次数："+j.__renderedTimes),a.each(function(){var a,d=b(this),f=d.data(j.componentHtmlAttr),g=d.attr("data-"+j.componentOptionsHtmlAttr)||null;g&&(g=c.process(g),g=g.replace(/__CTX__/gm,j.ctxPath)),g=b.parseJSON(g)||{},""!==b.trim(f)&&(a=f.indexOf("|")!==-1?f.split("|"):[f],b.isArray(g)||(g=[g]),b.each(a,function(a,c){var f=g[a]||{},h=j.component[b.trim(c)],i=c;if(h)h.call(d,f);else{switch(c){case"datagrid":i="bootgrid";break;case"bootgrid":i="bootgrid";break;case"datagrid-delete":i="datagrid-delete";break;case"drawer":i="drawer";break;case"form":i="form";break;case"validator":i="validator";break;case"chosen":i="chosen";break;case"webuploader":i="webuploader";break;case"menuTree":i="menutree";break;case"Intro":i="Intro";break;case"loadContent":i="loadContent";break;case"datepicker":i="datepicker";break;case"datetimepicker":i="datetimepicker";break;default:var k="未被注册的组件["+c+"]";return console.info(e().format("YYYY年MM月DD日 HH:MM:SS")+" "+k),window.layer.msg(k),void d.attr("notrecognized","not reg")}seajs.use([i],function(){j.component[b.trim(c)].call(d,f)})}}))})}catch(a){throw a}finally{j.__isrendering=!1}},setAutoRender:function(a){return 0===arguments.length?void console.info("/(ㄒoㄒ)/~~ 请设置参数。"):(j.isAutoRender=Boolean(a),void(a?j.setAutoRender.pointcutHandlerList=[d.after(b.prototype,"html",j.render)]:b.each(j.setAutoRender.pointcutHandlerList,function(a,b){b.remove()})))}}),b.extend(j,{handleJsonResult:function(a){return"string"==typeof a&&(a=b.parseJSON(a)),a},handleGridResult:function(a){return j.handleJsonResult(a)},getTreeList:function(a){function c(a){var d=[];return a&&a.length?(b.each(a,function(a,e){var f,g=e;f=b.extend(!0,{},g),f[j]=c(k[g[h]]),d.push(f)}),d):null}var d,e,f=a.data,g=a.rootId,h=a.idName||"id",i=a.parentIdName||"parentId",j=a.childrenName||"children",k={},l=[];return null===g||void 0===g?b.each(f,function(a,b){var c=b[i];null!==c&&void 0!==c&&c!==-1&&"-1"!==c||l.push(b)}):"object"==typeof g?b.each(f,function(a,b){var c=b[h];g.hasOwnProperty(c)&&l.push(b)}):b.each(f,function(a,b){var c=b[h];if(c===g)return l.push(b),!1}),b.each(f,function(a,b){null!==b&&void 0!==b&&(e=b[i],k[e]=k[e]||[],k[e].push(b))}),d=c(l)}}),j._init()});